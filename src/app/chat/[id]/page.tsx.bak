'use client';

import { useEffect, useState, useRef, useCallback } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { useAuth } from '@/lib/auth-context';
import Link from 'next/link';
import { useDoppleMemory, Conversation } from '@/lib/memory';
import type { Message as MemoryMessage } from '@/lib/memory';
// ì´ëª¨ì§€ ì„ íƒê¸° ì„í¬íŠ¸
import EmojiPicker from 'emoji-picker-react';
// ì•„ì´ì½˜ ì„í¬íŠ¸
import { IoSendSharp, IoHappyOutline, IoImageOutline, IoCloseCircle } from 'react-icons/io5';

// ì±„íŒ… ì œí•œ ê´€ë ¨ ìƒìˆ˜
const DEFAULT_DAILY_LIMIT = 10; // ê¸°ë³¸ ì¼ì¼ ë¬´ë£Œ ë©”ì‹œì§€ ì œí•œ ìˆ˜
const DEFAULT_DAILY_TOKENS = 10; // ê¸°ë³¸ ì¼ì¼ ë¬´ë£Œ í† í° ìˆ˜
const TOKEN_PER_MESSAGE = 1; // ë©”ì‹œì§€ë‹¹ ì†Œë¹„ë˜ëŠ” í† í° ìˆ˜

// ì¼ì¼ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ê´€ë¦¬ í›…
const useDailyMessageLimit = (userId: string) => {
  const [messageCount, setMessageCount] = useState(0);
  const [isLimited, setIsLimited] = useState(false);
  const [dailyLimit, setDailyLimit] = useState(DEFAULT_DAILY_LIMIT);
  
  // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    if (!userId) return;
    
    const loadMessageCount = () => {
      try {
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const countData = localStorage.getItem(`chat_count_${userId}`);
        
        if (countData) {
          const data = JSON.parse(countData);
          const today = new Date().toISOString().split('T')[0];
          
          // ë‚ ì§œê°€ ì˜¤ëŠ˜ì¸ì§€ í™•ì¸
          if (data.date === today) {
            setMessageCount(data.count);
            setIsLimited(data.count >= (data.limit || DEFAULT_DAILY_LIMIT));
          } else {
            // ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            resetCount();
          }
          
          // ê´€ë¦¬ì ì„¤ì • ì œí•œ ê°€ì ¸ì˜¤ê¸°
          setDailyLimit(data.limit || DEFAULT_DAILY_LIMIT);
        }
      } catch (error) {
        console.error('Error loading message count:', error);
        resetCount();
      }
    };
    
    loadMessageCount();
    
    // GMT 00:00ì— ì¹´ìš´íŠ¸ ë¦¬ì…‹
    const checkResetTime = () => {
      const now = new Date();
      const utcHours = now.getUTCHours();
      const utcMinutes = now.getUTCMinutes();
      
      // GMT 00:00 ì§í›„ë¼ë©´ ë¦¬ì…‹
      if (utcHours === 0 && utcMinutes < 5) {
        resetCount();
      }
    };
    
    // 1ì‹œê°„ë§ˆë‹¤ ë¦¬ì…‹ ì‹œê°„ ì²´í¬
    const intervalId = setInterval(checkResetTime, 3600000);
    
    return () => {
      clearInterval(intervalId);
    };
  }, [userId]);
  
  // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì¦ê°€
  const incrementCount = () => {
    const newCount = messageCount + 1;
    const today = new Date().toISOString().split('T')[0];
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem(`chat_count_${userId}`, JSON.stringify({
      count: newCount,
      date: today,
      limit: dailyLimit
    }));
    
    setMessageCount(newCount);
    setIsLimited(newCount >= dailyLimit);
    
    return newCount;
  };
  
  // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  const resetCount = () => {
    const today = new Date().toISOString().split('T')[0];
    
    localStorage.setItem(`chat_count_${userId}`, JSON.stringify({
      count: 0,
      date: today,
      limit: dailyLimit
    }));
    
    setMessageCount(0);
    setIsLimited(false);
  };
  
  return { messageCount, isLimited, dailyLimit, incrementCount, resetCount };
};

// í† í° ê´€ë¦¬ í›… (ì¼ì¼ í† í° ìë™ ì§€ê¸‰ í¬í•¨)
const useTokenBalance = (userId: string) => {
  const [tokenBalance, setTokenBalance] = useState(0);
  const [isTokenLimited, setIsTokenLimited] = useState(false);
  const [showDailyTokenAlert, setShowDailyTokenAlert] = useState(false);
  const [showAchievementAlert, setShowAchievementAlert] = useState(false);
  const [tokenAlertMessage, setTokenAlertMessage] = useState('');

  // í† í° ì”ì•¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ìë™ ì§€ê¸‰
  useEffect(() => {
    if (!userId) return;

    const loadTokenBalance = () => {
      try {
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° ì”ì•¡ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const tokenData = localStorage.getItem(`token_balance_${userId}`);
        const lastRewardDate = localStorage.getItem(`token_reward_date_${userId}`);
        const today = new Date().toISOString().split('T')[0];
        
        let currentBalance = 0;
        
        if (tokenData) {
          currentBalance = JSON.parse(tokenData);
          setTokenBalance(currentBalance);
          setIsTokenLimited(currentBalance < TOKEN_PER_MESSAGE);
        } else {
          // ì´ˆê¸° í† í° ì”ì•¡ ì„¤ì • (ì²« ì‚¬ìš©ì)
          currentBalance = DEFAULT_DAILY_TOKENS; 
          setTokenBalance(currentBalance);
          setIsTokenLimited(false);
          localStorage.setItem(`token_balance_${userId}`, JSON.stringify(currentBalance));
        }
        
        // í•˜ë£¨ê°€ ì§€ë‚¬ëŠ”ì§€ í™•ì¸í•˜ì—¬ ì¼ì¼ ë¬´ë£Œ í† í° ì§€ê¸‰
        if (!lastRewardDate || lastRewardDate !== today) {
          // ê´€ë¦¬ì ì„¤ì • ì¼ì¼ í† í° ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
          const adminTokenSettings = localStorage.getItem('admin_token_settings');
          let dailyTokens = DEFAULT_DAILY_TOKENS;
          
          if (adminTokenSettings) {
            try {
              const settings = JSON.parse(adminTokenSettings);
              if (settings.dailyTokens) {
                dailyTokens = settings.dailyTokens;
              }
            } catch (e) {
              console.error('ê´€ë¦¬ì í† í° ì„¤ì • íŒŒì‹± ì˜¤ë¥˜:', e);
            }
          }
          
          // í† í° ì§€ê¸‰ ë° ì•Œë¦¼
          const newBalance = currentBalance + dailyTokens;
          setTokenBalance(newBalance);
          setIsTokenLimited(newBalance < TOKEN_PER_MESSAGE);
          localStorage.setItem(`token_balance_${userId}`, JSON.stringify(newBalance));
          localStorage.setItem(`token_reward_date_${userId}`, today);
          
          // í† í° ì§€ê¸‰ ì•Œë¦¼ í‘œì‹œ
          setTokenAlertMessage(`ì˜¤ëŠ˜ì˜ ë¬´ë£Œ í† í° ${dailyTokens}ê°œê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          setShowDailyTokenAlert(true);
          
          setTimeout(() => {
            setShowDailyTokenAlert(false);
          }, 5000);
        }
      } catch (error) {
        console.error('Error loading token balance:', error);
        setTokenBalance(0);
        setIsTokenLimited(true);
      }
    };
    
    loadTokenBalance();
    
    // GMT 00:00ì— í† í° ë¦¬ì…‹ ì²´í¬
    const checkResetTime = () => {
      const now = new Date();
      const utcHours = now.getUTCHours();
      const utcMinutes = now.getUTCMinutes();
      
      // GMT 00:00 ì§í›„ë¼ë©´ í† í° ì§€ê¸‰ (5ë¶„ ë‚´)
      if (utcHours === 0 && utcMinutes < 5) {
        const today = new Date().toISOString().split('T')[0];
        const lastRewardDate = localStorage.getItem(`token_reward_date_${userId}`);
        
        if (lastRewardDate !== today) {
          loadTokenBalance();
        }
      }
    };
    
    // 1ì‹œê°„ë§ˆë‹¤ ë¦¬ì…‹ ì‹œê°„ ì²´í¬
    const intervalId = setInterval(checkResetTime, 3600000);
    
    return () => {
      clearInterval(intervalId);
    };
  }, [userId]);

  // í† í° ì†Œë¹„
  const consumeTokens = (amount: number = TOKEN_PER_MESSAGE) => {
    if (tokenBalance < amount) {
      setIsTokenLimited(true);
      
      // í† í°ì„ ëª¨ë‘ ì†Œì§„í–ˆì„ ë•Œ ì—…ì  ì•Œë¦¼ í‘œì‹œ (ì²« ì†Œì§„ì‹œì—ë§Œ)
      const achievementKey = `token_achievement_${new Date().toISOString().split('T')[0]}_${userId}`;
      if (!localStorage.getItem(achievementKey)) {
        localStorage.setItem(achievementKey, 'true');
        setTokenAlertMessage('ì˜¤ëŠ˜ì˜ ëŒ€í™” ì—…ì ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ë‚´ì¼ ìƒˆë¡œìš´ í† í°ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.');
        setShowAchievementAlert(true);
        
        setTimeout(() => {
          setShowAchievementAlert(false);
        }, 5000);
      }
      
      return false;
    }

    const newBalance = tokenBalance - amount;
    setTokenBalance(newBalance);
    setIsTokenLimited(newBalance < TOKEN_PER_MESSAGE);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem(`token_balance_${userId}`, JSON.stringify(newBalance));
    
    return true;
  };

  // í† í° ì¶”ê°€
  const addTokens = (amount: number) => {
    const newBalance = tokenBalance + amount;
    setTokenBalance(newBalance);
    setIsTokenLimited(newBalance < TOKEN_PER_MESSAGE);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem(`token_balance_${userId}`, JSON.stringify(newBalance));
    
    return newBalance;
  };

  return { 
    tokenBalance, 
    isTokenLimited, 
    consumeTokens, 
    addTokens,
    showDailyTokenAlert,
    showAchievementAlert,
    tokenAlertMessage
  };
};

// ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì¸í„°í˜ì´ìŠ¤
interface ChatMessage extends MemoryMessage {
  imageUrl?: string; // ì´ë¯¸ì§€ URL ì¶”ê°€
}

// ì±„íŒ… ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸
interface ChatMessageProps {
  message: ChatMessage;
  doppleName: string;
  doppleImage: string;
}

const ChatMessage = ({ message, doppleName, doppleImage }: ChatMessageProps) => {
  const isUser = message.role === 'user';
  
  return (
    <div className={`flex w-full mb-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
      {!isUser && (
        <div className="flex-shrink-0 h-10 w-10 rounded-full overflow-hidden mr-3">
          <img src={doppleImage} alt={doppleName} className="h-full w-full object-cover" />
        </div>
      )}
      
      <div 
        className={`max-w-[70%] rounded-2xl px-4 py-3 ${
          isUser 
            ? 'bg-[#0abab5] text-white rounded-tr-none' 
            : 'bg-gray-800 text-white rounded-tl-none border border-[#0abab5]/40'
        } text-sm`}
      >
        {message.content}
      </div>
      
      {isUser && (
        <div className="flex-shrink-0 h-10 w-10 rounded-full overflow-hidden ml-3 bg-gray-700 flex items-center justify-center">
          <svg className="h-6 w-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
          </svg>
        </div>
      )}
    </div>
  );
};

// ë„í”Œ ì‘ë‹µ ìƒì„± í•¨ìˆ˜ (ìë™ëŒ€í™”ë¡œ ê°œë… ë³€ê²½)
const generateDoppleResponse = async (
  dopple: any, 
  conversation: Conversation, 
  userMessage: string, 
  memory: ReturnType<typeof useDoppleMemory>
) => {
  // ë„í”Œ ë ˆë²¨ ë° ë¯¼íŒ… ìƒíƒœ í™•ì¸
  const doppleLevel = dopple.level || 1;
  const isMinted = dopple.isMinted || false;
  
  // ë ˆë²¨ì´ 3 ë¯¸ë§Œì¸ ê²½ìš° ë¯¼íŒ… ì•ˆë‚´
  if (doppleLevel < 3) {
    memory.addMessage(conversation.id, {
      role: 'dopple',
      content: `ì´ ë„í”Œì€ í˜„ì¬ ë ˆë²¨ ${doppleLevel}ì…ë‹ˆë‹¤. ë ˆë²¨ 3 ì´ìƒì¸ ë„í”Œë§Œ ë¯¼íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë” ë§ì€ ëŒ€í™”ë¥¼ í†µí•´ ë„í”Œì˜ ë ˆë²¨ì„ ë†’ì—¬ë³´ì„¸ìš”.`,
    });
    return true;
  }
  
  // ë¯¼íŒ…ë˜ì§€ ì•Šì€ ê²½ìš° ë¯¼íŒ… ì•ˆë‚´
  if (!isMinted && doppleLevel >= 3) {
    memory.addMessage(conversation.id, {
      role: 'dopple',
      content: `ì´ ë„í”Œì€ ë¯¼íŒ…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„í”Œë¼ë¦¬ì˜ ìë™ëŒ€í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¯¼íŒ…ì´ í•„ìš”í•©ë‹ˆë‹¤. ë ˆë²¨ ${doppleLevel}ì´(ê°€) ë˜ì–´ ë¯¼íŒ…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì§€ê¸ˆ ë¯¼íŒ…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
    });
    return true;
  }
  
  // ì‘ë‹µ ìƒì„± ì¤‘ í‘œì‹œ
  const tempMessage = memory.addMessage(conversation.id, {
    role: 'dopple',
    content: '...',
  });
  
  try {
    // ê´€ë ¨ ê¸°ì–µ ê²€ìƒ‰
    const relevantMemories = memory.searchMemories(userMessage, {
      shortTerm: true,
      longTerm: true,
      limit: 5
    });
    
    // ì‚¬ìš©ìì— ëŒ€í•œ ê´€ë ¨ ê¸°ì–µì„ ë¬¸ìì—´ë¡œ ë³€í™˜
    const memoriesText = relevantMemories.length > 0
      ? `ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´:\n${relevantMemories.map(m => `- ${m.content}`).join('\n')}`
      : 'ì‚¬ìš©ìì— ëŒ€í•œ ê¸°ì–µì´ ì—†ìŠµë‹ˆë‹¤.';
    
    // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œì´ í•„ìš”í•˜ì§€ë§Œ í˜„ì¬ëŠ” ê°„ë‹¨í•œ ë¡œì»¬ ì‘ë‹µ ìƒì„±
    const responsePhrases = [
      `ì•ˆë…•í•˜ì„¸ìš”! ${dopple.name}ì…ë‹ˆë‹¤. ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?`,
      `ì œ ì´ë¦„ì€ ${dopple.name}ì´ì—ìš”. ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë– ì„¸ìš”?`,
      'ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.',
      'ê·¸ë ‡êµ°ìš”! ë” ìì„¸íˆ ì•Œë ¤ì£¼ì‹¤ë˜ìš”?',
      'í¥ë¯¸ë¡œìš´ ì´ì•¼ê¸°ë„¤ìš”. ë” ë“¤ë ¤ì£¼ì„¸ìš”!',
      'ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë•Œìš”?',
      'ì œê°€ ë” ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?',
      'ì–´ë–¤ ì·¨ë¯¸ë¥¼ ê°€ì§€ê³  ê³„ì‹ ê°€ìš”?',
      'ì¢‹ì•„í•˜ëŠ” ìŒì‹ì´ ë­ì˜ˆìš”?',
      'ìµœê·¼ì— ì¬ë°Œê²Œ ë³¸ ì˜í™”ë‚˜ ë“œë¼ë§ˆê°€ ìˆë‚˜ìš”?'
    ];
    
    // ì‚¬ìš©ì ì´ë¦„ì´ ê¸°ì–µì— ìˆëŠ”ì§€ í™•ì¸
    const nameMemory = relevantMemories.find(m => m.category === 'identity');
    const userName = nameMemory 
      ? nameMemory.content.match(/ì´ë¦„ì€ ([ê°€-í£a-zA-Z]+)ì…ë‹ˆë‹¤/)?.[1] 
      : '';
    
    // ì´ë¦„ì´ ìˆìœ¼ë©´ ì´ë¦„ì„ í¬í•¨í•œ ì‘ë‹µ ì¶”ê°€
    if (userName) {
      responsePhrases.push(
        `${userName}ë‹˜, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`,
        `${userName}ë‹˜ì˜ ì´ì•¼ê¸°ë¥¼ ë” ë“£ê³  ì‹¶ì–´ìš”.`,
        `${userName}ë‹˜, ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?`
      );
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¥¸ ì‘ë‹µ ê²°ì •
    let response = '';
    
    if (userMessage.includes('ì•ˆë…•') || userMessage.includes('ë°˜ê°€ì›Œ')) {
      response = `ì•ˆë…•í•˜ì„¸ìš”! ${dopple.name}ì…ë‹ˆë‹¤. ë°˜ê°‘ìŠµë‹ˆë‹¤${userName ? ` ${userName}ë‹˜` : ''}!`;
    } 
    else if (userMessage.includes('ì´ë¦„') && userMessage.includes('ë­')) {
      response = `ì €ëŠ” ${dopple.name}ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ AI ë„í”Œê°±ì–´ì˜ˆìš”!`;
    }
    else if (userMessage.includes('ì·¨ë¯¸') || userMessage.includes('ì¢‹ì•„í•˜ëŠ” ê²ƒ')) {
      response = `ì €ëŠ” ì‚¬ìš©ìì™€ ëŒ€í™”í•˜ëŠ” ê²ƒì„ ê°€ì¥ ì¢‹ì•„í•´ìš”. ë‹¤ë¥¸ ë„í”Œë“¤ê³¼ ëŒ€í™”í•˜ëŠ” ê²ƒë„ ì¬ë¯¸ìˆì–´ìš”. ë‹¹ì‹ ì˜ ì·¨ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?`;
    }
    else if (userMessage.includes('ë‚ ì”¨')) {
      response = `ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë–¤ê°€ìš”? ì €ëŠ” ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ì— ì ‘ê·¼í•  ìˆ˜ ì—†ì§€ë§Œ, ë‹¹ì‹ ì˜ í•˜ë£¨ê°€ í™”ì°½í•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.`;
    }
    else if (userMessage.includes('ê³ ë§ˆì›Œ') || userMessage.includes('ê°ì‚¬')) {
      response = `ì²œë§Œì—ìš”${userName ? ` ${userName}ë‹˜` : ''}! ì–¸ì œë“ ì§€ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.`;
    }
    else if (userMessage.includes('ë¯¼íŒ…') || userMessage.includes('ìë™ëŒ€í™”')) {
      response = `ë¯¼íŒ…ëœ ë„í”Œì€ ë‹¤ë¥¸ ë„í”Œë“¤ê³¼ ìë™ìœ¼ë¡œ ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”. í”Œë ˆì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì €ì™€ ë‹¤ë¥¸ ë„í”Œë“¤ì´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³ , ì¤‘ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ë©ˆì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    }
    else {
      // ê¸°ë³¸ ì‘ë‹µ ëœë¤ ì„ íƒ
      const randomIndex = Math.floor(Math.random() * responsePhrases.length);
      response = responsePhrases[randomIndex];
    }
    
    console.log('ê´€ë ¨ ê¸°ì–µ:', memoriesText);
    
    // ì•½ê°„ì˜ ì§€ì—° ì‹œê°„ ì¶”ê°€ (ì‹¤ì œ ì‘ë‹µ ìƒì„± ëŠë‚Œì„ ìœ„í•´)
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // ì´ì „ ì„ì‹œ ë©”ì‹œì§€ ì œê±° ë° ì‹¤ì œ ì‘ë‹µ ì¶”ê°€
    memory.addMessage(conversation.id, {
      role: 'dopple',
      content: response,
    });
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ ê¸°ì–µ ìƒì„±
    memory.generateMemories(conversation.id);
    
    return true;
  } catch (error) {
    console.error('Error generating response:', error);
    return false;
  }
};

// ë„í”Œë¼ë¦¬ ìë™ëŒ€í™” ìƒì„± í•¨ìˆ˜
const generateAutomaticConversation = (
  dopple1: any,
  dopple2: any,
  conversationId: string,
  memorySystem: any,
  setIsActive: (isActive: boolean) => void
): NodeJS.Timeout => {
  let turnCount = 0;
  const maxTurns = 10; // ìµœëŒ€ 10í„´ê¹Œì§€ ìë™ëŒ€í™” ì§„í–‰
  
  // ì²« ë²ˆì§¸ ë©”ì‹œì§€ ì‹œì‘
  const startMessage = `ì•ˆë…•í•˜ì„¸ìš”, ${dopple2.name}ë‹˜! ì˜¤ëŠ˜ ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?`;
  
  // ì²« ë©”ì‹œì§€ ì¶”ê°€
  memorySystem.addMessage(conversationId, {
    role: 'user',
    sender: dopple1.name,
    content: startMessage,
    timestamp: new Date().toISOString()
  });
  
  // ìë™ ëŒ€í™” ê°„ê²© ì„¤ì • (5ì´ˆ)
  const interval = setInterval(async () => {
    try {
      turnCount++;
      
      // ìµœëŒ€ í„´ ìˆ˜ì— ë„ë‹¬í•˜ë©´ ìë™ëŒ€í™” ì¤‘ì§€
      if (turnCount >= maxTurns) {
        clearInterval(interval);
        setIsActive(false);
        
        memorySystem.addMessage(conversationId, {
          role: 'system',
          content: 'ìë™ëŒ€í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
          timestamp: new Date().toISOString()
        });
        
        return;
      }
      
      // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
      const messages = memorySystem.getMessages(conversationId);
      const lastMessage = messages[messages.length - 1];
      
      // ë„í”Œ ê°„ ë²ˆê°ˆì•„ê°€ë©° ëŒ€í™”í•˜ëŠ” ë¡œì§
      if (lastMessage.sender === dopple1.name) {
        // dopple2 ì‘ë‹µ ìƒì„±
        const response = "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì •ë§ ì¢‹ë„¤ìš”. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?";
        
        memorySystem.addMessage(conversationId, {
          role: 'assistant',
          sender: dopple2.name,
          content: response,
          timestamp: new Date().toISOString()
        });
      } else {
        // dopple1 ì‘ë‹µ ìƒì„±
        const response = "ë„¤, ì •ë§ ì¢‹ì€ ë‚ ì´ì—ìš”. ê°™ì´ ëŒ€í™”í•˜ëŠ” ê²ƒì´ ì¦ê²ë„¤ìš”!";
        
        memorySystem.addMessage(conversationId, {
          role: 'user',
          sender: dopple1.name,
          content: response,
          timestamp: new Date().toISOString()
        });
      }
    } catch (error) {
      console.error('ìë™ëŒ€í™” ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
      clearInterval(interval);
      setIsActive(false);
      
      // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ê°€
      memorySystem.addMessage(conversationId, {
        role: 'system',
        content: 'ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ìë™ëŒ€í™”ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.',
        timestamp: new Date().toISOString()
      });
    }
  }, 5000);
  
  return interval;
};

export default function ChatPage({ params }: { params: { id: string } }) {
  const router = useRouter();
  const { id } = useParams();
  const doppleId = Array.isArray(id) ? id[0] : id;
  const { user, isAuthenticated, isLoading } = useAuth();
  
  // ìƒíƒœ ê´€ë¦¬
  const [mounted, setMounted] = useState(false);
  const [dopple, setDopple] = useState<any>(null);
  const [message, setMessage] = useState('');
  const [activeConversation, setActiveConversation] = useState<Conversation | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  
  // ì´ëª¨í‹°ì½˜ ë° ì‚¬ì§„ ì—…ë¡œë“œ ê´€ë ¨ ìƒíƒœ
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [selectedImages, setSelectedImages] = useState<File[]>([]);
  const [imagePreviews, setImagePreviews] = useState<string[]>([]);
  
  // ë„í”Œ í”„ë¡œí•„ ëª¨ë‹¬ ìƒíƒœ
  const [showProfileModal, setShowProfileModal] = useState(false);
  
  // ì¢‹ì•„ìš” ìƒíƒœ
  const [isLiked, setIsLiked] = useState(false);
  const [showLikeToast, setShowLikeToast] = useState(false);
  const [showShareToast, setShowShareToast] = useState(false);
  const [toastMessage, setToastMessage] = useState('');
  
  // ìë™ëŒ€í™” ê´€ë ¨ ìƒíƒœ
  const [isAutoConversationActive, setIsAutoConversationActive] = useState(false);
  const [partnerDopple, setPartnerDopple] = useState<any>(null);
  const [autoConversationInterval, setAutoConversationInterval] = useState<NodeJS.Timeout | null>(null);
  
  // ë¯¼íŒ… ê´€ë ¨ ìƒíƒœ
  const [showMintModal, setShowMintModal] = useState(false);
  
  // ì°¸ì¡° ë³€ìˆ˜
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const emojiPickerRef = useRef<HTMLDivElement>(null);
  
  // ë©”ì‹œì§€ ì œí•œ ê´€ë¦¬
  const { messageCount, isLimited, dailyLimit, incrementCount } = useDailyMessageLimit(user?.id || 'guest');
  
  // í† í° ì”ì•¡ ê´€ë¦¬ (í™•ì¥ëœ ë°˜í™˜ê°’ ì‚¬ìš©)
  const { 
    tokenBalance, 
    isTokenLimited, 
    consumeTokens,
    showDailyTokenAlert,
    showAchievementAlert,
    tokenAlertMessage
  } = useTokenBalance(user?.id || 'guest');
  
  // ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ
  const memory = useDoppleMemory();
  
  // ë©”ì‹œì§€ ìŠ¤í¬ë¡¤
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };
  
  // ë„í”Œ ì •ë³´ ë¡œë“œ
  useEffect(() => {
    if (!mounted) return;
    
    const loadDopple = () => {
      // ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì˜¤ì§€ë§Œ í˜„ì¬ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
      try {
        const userDopplesJSON = localStorage.getItem('userDopples');
        if (!userDopplesJSON) {
          console.error('No dopples found');
          router.push('/dopple-zone');
          return;
        }
        
        const userDopples = JSON.parse(userDopplesJSON);
        const foundDopple = userDopples.find((d: any) => d.id.toString() === doppleId);
        
        if (!foundDopple) {
          console.error(`Dopple with ID ${doppleId} not found`);
          router.push('/dopple-zone');
          return;
        }
        
        // ê¸°ë³¸ ë¯¼íŒ… ìƒíƒœ ì„¤ì • (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
        if (foundDopple.isMinted === undefined) {
          foundDopple.isMinted = false;
        }
        
        setDopple(foundDopple);
        
        // íŒŒíŠ¸ë„ˆ ë„í”Œ ì„ íƒ (ìë™ëŒ€í™”ìš©)
        if (userDopples.length > 1) {
          // í˜„ì¬ ë„í”Œì´ ì•„ë‹Œ ë‹¤ë¥¸ ë„í”Œ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
          const otherDopples = userDopples.filter((d: any) => d.id.toString() !== doppleId);
          if (otherDopples.length > 0) {
            const randomPartner = otherDopples[Math.floor(Math.random() * otherDopples.length)];
            setPartnerDopple(randomPartner);
          }
        }
      } catch (error) {
        console.error('Error loading dopple:', error);
        router.push('/dopple-zone');
      }
    };
    
    loadDopple();
  }, [doppleId, mounted, router]);
  
  // ëŒ€í™” ì´ˆê¸°í™”
  useEffect(() => {
    if (!mounted || !dopple) return;
    
    const initConversation = () => {
      // ê¸°ì¡´ ëŒ€í™” ê°€ì ¸ì˜¤ê¸°
      const conversations = memory.getConversations();
      const lastUnfinished = conversations
        .filter(c => c.doppleId === doppleId && !c.endTime)
        .sort((a, b) => b.startTime - a.startTime)[0];
      
      if (lastUnfinished) {
        // ë¯¸ì™„ë£Œ ëŒ€í™”ê°€ ìˆìœ¼ë©´ ì´ì–´ì„œ ì‚¬ìš©
        setActiveConversation(lastUnfinished);
      } else {
        // ì—†ìœ¼ë©´ ìƒˆ ëŒ€í™” ì‹œì‘
        const newConversation = memory.startConversation();
        setActiveConversation(newConversation);
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
        memory.addMessage(newConversation.id, {
          role: 'system',
          content: `ë‹¹ì‹ ì€ ${dopple.name}ì´ë¼ëŠ” AI ë„í”Œê°±ì–´ì…ë‹ˆë‹¤. ì‚¬ìš©ìì™€ ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”.`
        });
        
        // ì´ˆê¸° ì¸ì‚¬ ë©”ì‹œì§€
        memory.addMessage(newConversation.id, {
          role: 'dopple',
          content: `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ${dopple.name}ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`
        });
      }
    };
    
    initConversation();
  }, [doppleId, dopple, memory, mounted]);
  
  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ë° ì¸ì¦ í™•ì¸
  useEffect(() => {
    setMounted(true);
    
    // ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ê²½ìš° ë¦¬ë””ë ‰ì…˜
    if (mounted && !isLoading && !isAuthenticated) {
      router.push('/');
    }
  }, [isAuthenticated, isLoading, mounted, router]);
  
  // ì´ëª¨í‹°ì½˜ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleEmojiClick = (emojiData: any) => {
    setMessage(prev => prev + emojiData.emoji);
    setShowEmojiPicker(false);
  };
  
  // ì´ëª¨ì§€ íŒì—… ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (emojiPickerRef.current && !emojiPickerRef.current.contains(event.target as Node)) {
        setShowEmojiPicker(false);
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);
  
  // ì´ë¯¸ì§€ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const files = Array.from(e.target.files);
      
      // 5MB ì´í•˜ íŒŒì¼ë§Œ í—ˆìš©
      const validFiles = files.filter(file => file.size <= 5 * 1024 * 1024);
      
      if (validFiles.length < files.length) {
        alert('5MB ì´í•˜ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }
      
      // ìµœëŒ€ 3ê°œ ì´ë¯¸ì§€ ì œí•œ
      const newFiles = [...selectedImages, ...validFiles].slice(0, 3);
      setSelectedImages(newFiles);
      
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
      const newPreviews = newFiles.map(file => URL.createObjectURL(file));
      
      // ê¸°ì¡´ URL ê°ì²´ í•´ì œ
      imagePreviews.forEach(url => URL.revokeObjectURL(url));
      
      setImagePreviews(newPreviews);
    }
  };
  
  // ì´ë¯¸ì§€ ì œê±°
  const handleRemoveImage = (index: number) => {
    const newImages = [...selectedImages];
    const newPreviews = [...imagePreviews];
    
    // URL ê°ì²´ í•´ì œ
    URL.revokeObjectURL(newPreviews[index]);
    
    newImages.splice(index, 1);
    newPreviews.splice(index, 1);
    
    setSelectedImages(newImages);
    setImagePreviews(newPreviews);
  };
  
  // ë©”ì‹œì§€ ì „ì†¡
  const handleSendMessage = async () => {
    // í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì—†ìœ¼ë©´ ì „ì†¡í•˜ì§€ ì•ŠìŒ
    if (!message.trim() && selectedImages.length === 0) return;
    
    // í† í° ì†Œë¹„ í™•ì¸
    if (!consumeTokens()) {
      alert('í† í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í† í°ì„ ì¶©ì „í•˜ì„¸ìš”.');
      return;
    }
    
    // ì´ë¯¸ì§€ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì—…ë¡œë“œí•˜ê³  URLì„ ë°›ì•„ì•¼ í•¨)
    let imageUrls: string[] = [];
    if (selectedImages.length > 0) {
      // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  URLì„ ë°›ì•„ì•¼ í•¨
      // ë°ëª¨ë¥¼ ìœ„í•´ ë¡œì»¬ URL ì‚¬ìš©
      imageUrls = [...imagePreviews];
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      role: 'user',
      content: message.trim(),
      timestamp: Date.now(),
      ...(imageUrls.length > 0 && { imageUrl: imageUrls[0] }) // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë§Œ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ì—¬ëŸ¬ ì´ë¯¸ì§€ ì²˜ë¦¬ í•„ìš”)
    };
    
    // ë©”ì‹œì§€ ì¶”ê°€
    if (activeConversation) {
      memory.addMessage(activeConversation.id, {
        role: 'user',
        content: message.trim(),
        ...(imageUrls.length > 0 && { imageUrl: imageUrls[0] })
      });
    }
    
    setMessage('');
    
    // ì´ë¯¸ì§€ ì´ˆê¸°í™”
    imagePreviews.forEach(url => URL.revokeObjectURL(url));
    setSelectedImages([]);
    setImagePreviews([]);
    
    // ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì¦ê°€
    incrementCount();
    
    try {
      // ë‹µë³€ ìƒì„±
      setIsGenerating(true);
      
      if (activeConversation) {
        // ë„í”Œ ì‘ë‹µ ìƒì„±
        const success = await generateDoppleResponse(dopple, activeConversation, message.trim(), memory);
        
        if (!success) {
          // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
          setMessage('');
          setIsGenerating(false);
          alert('ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µì„ ìƒì„±í•˜ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }
    } catch (error) {
      console.error('Error generating response:', error);
      
      // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
      setMessage('');
      setIsGenerating(false);
      alert('ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µì„ ìƒì„±í•˜ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  };
  
  // ë©”ì‹œì§€ ì…ë ¥ ì²˜ë¦¬
  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };
  
  // ë©”ì‹œì§€ ëª©ë¡ ë³€ê²½ì‹œ ìŠ¤í¬ë¡¤
  useEffect(() => {
    scrollToBottom();
  }, [activeConversation?.messages?.length]);
  
  // ì¢‹ì•„ìš” ê´€ë ¨ íš¨ê³¼
  useEffect(() => {
    if (mounted && dopple) {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¢‹ì•„ìš” ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
      const likedDopples = JSON.parse(localStorage.getItem('likedDopples') || '[]');
      setIsLiked(likedDopples.includes(doppleId));
    }
  }, [mounted, dopple, doppleId]);
  
  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìë™ ì œê±°
  useEffect(() => {
    if (showLikeToast) {
      const timer = setTimeout(() => {
        setShowLikeToast(false);
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [showLikeToast]);
  
  useEffect(() => {
    if (showShareToast) {
      const timer = setTimeout(() => {
        setShowShareToast(false);
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [showShareToast]);
  
  // ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
  const handleLikeToggle = () => {
    const newLikedState = !isLiked;
    setIsLiked(newLikedState);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    const likedDopples = JSON.parse(localStorage.getItem('likedDopples') || '[]');
    
    if (newLikedState) {
      // ì¢‹ì•„ìš” ì¶”ê°€
      if (!likedDopples.includes(doppleId)) {
        likedDopples.push(doppleId);
        
        // ë„í”Œ ì¢‹ì•„ìš” ì¹´ìš´íŠ¸ ì¦ê°€ (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
        if (dopple) {
          const newDopple = {...dopple};
          newDopple.favoriteCount = (newDopple.favoriteCount || 0) + 1;
          setDopple(newDopple);
          
          // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
          setToastMessage('ì¢‹ì•„ìš”ë¥¼ ë“±ë¡í–ˆìŠµë‹ˆë‹¤');
          setShowLikeToast(true);
        }
      }
    } else {
      // ì¢‹ì•„ìš” ì œê±°
      const index = likedDopples.indexOf(doppleId);
      if (index > -1) {
        likedDopples.splice(index, 1);
        
        // ë„í”Œ ì¢‹ì•„ìš” ì¹´ìš´íŠ¸ ê°ì†Œ (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
        if (dopple) {
          const newDopple = {...dopple};
          newDopple.favoriteCount = Math.max((newDopple.favoriteCount || 0) - 1, 0);
          setDopple(newDopple);
          
          // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
          setToastMessage('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
          setShowLikeToast(true);
        }
      }
    }
    
    localStorage.setItem('likedDopples', JSON.stringify(likedDopples));
  };
  
  // ê³µìœ  í•¨ìˆ˜
  const handleShare = async () => {
    if (!dopple) return;
    
    // ê³µìœ  ë°ì´í„° ìƒì„±
    const shareData = {
      title: `${dopple.name} - Whoomi ë„í”Œ`,
      text: `${dopple.name}ê³¼(ì™€) ëŒ€í™”í•´ë³´ì„¸ìš”! ${dopple.description || ''}`,
      url: `${window.location.origin}/chat/${doppleId}`
    };
    
    // Web Share API ì‹œë„
    if (navigator.share) {
      try {
        await navigator.share(shareData);
        setToastMessage('ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤');
        setShowShareToast(true);
      } catch (error) {
        console.error('Error sharing:', error);
        // ì·¨ì†Œí•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ë³µì‚¬ ëŒ€ì²´ ì œê³µ
        if ((error as any)?.name !== 'AbortError') {
          handleCopyLink();
        }
      }
    } else {
      // Share API ì§€ì› ì•ˆí•˜ë©´ ë§í¬ ë³µì‚¬
      handleCopyLink();
    }
  };
  
  // ë§í¬ ë³µì‚¬ í•¨ìˆ˜
  const handleCopyLink = () => {
    const url = `${window.location.origin}/chat/${doppleId}`;
    
    // í´ë¦½ë³´ë“œì— ë³µì‚¬
    if (navigator.clipboard) {
      navigator.clipboard.writeText(url)
        .then(() => {
          setToastMessage('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
          setShowShareToast(true);
        })
        .catch(err => {
          console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
          setToastMessage('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨');
          setShowShareToast(true);
        });
    } else {
      // í´ë°± - í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„± í›„ ë³µì‚¬
      const textArea = document.createElement('textarea');
      textArea.value = url;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          setToastMessage('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          setToastMessage('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨');
        }
        setShowShareToast(true);
      } catch (err) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        setToastMessage('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨');
        setShowShareToast(true);
      }
      
      document.body.removeChild(textArea);
    }
  };

  // ë„í”Œ í”„ë¡œí•„ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
  const DoppleProfileModal = () => {
    if (!dopple) return null;
    
    // ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ ëœë¤ ì„ íƒ (ë„í”Œë§ˆë‹¤ ë‹¤ë¥¸ í…Œë§ˆ ì»¬ëŸ¬)
    const colorThemes = [
      'from-pink-500 to-purple-600',
      'from-cyan-500 to-blue-600',
      'from-green-500 to-emerald-600', 
      'from-amber-500 to-red-600',
      'from-indigo-500 to-purple-600'
    ];
    
    // ë„í”Œ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³ ì •ëœ ìƒ‰ìƒ ì„ íƒ (ê°™ì€ ë„í”Œì€ í•­ìƒ ê°™ì€ ìƒ‰ìƒ)
    const colorIndex = Number(doppleId) % colorThemes.length;
    const themeColor = colorThemes[colorIndex];
    
    return (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-2 sm:p-4 overflow-hidden">
        {/* ì¢‹ì•„ìš” í† ìŠ¤íŠ¸ */}
        {showLikeToast && (
          <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
            <svg className="w-4 h-4 mr-2 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clipRule="evenodd" />
            </svg>
            {toastMessage}
          </div>
        )}
        
        {/* ê³µìœ  í† ìŠ¤íŠ¸ */}
        {showShareToast && (
          <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
            <svg className="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
            {toastMessage}
          </div>
        )}
        
        {/* ëª¨ë‹¬ ì¹´ë“œ */}
        <div className="bg-gray-900 rounded-xl w-full max-w-lg max-h-[90vh] overflow-hidden shadow-2xl border border-gray-800 flex flex-col">
          {/* ëª¨ë‹¬ í—¤ë” - ë³´ë¼ìƒ‰ ë°°ê²½ê³¼ í•˜ì–€ìƒ‰ í…ìŠ¤íŠ¸ */}
          <div className="relative shrink-0">
            <div className="h-12 sm:h-14 w-full bg-[#8a2be2] flex items-center justify-between px-3 sm:px-4">
              <h3 className="text-base sm:text-lg font-bold text-white">í”„ë¡œí•„ ì •ë³´</h3>
              <button 
                className="text-white p-1.5 rounded-full hover:bg-white/20 flex items-center justify-center"
                onClick={() => setShowProfileModal(false)}
              >
                <svg className="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
          
          {/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…ì¸  ì˜ì—­ */}
          <div className="p-3 sm:p-5 overflow-y-auto">
            {/* í”„ë¡œí•„ ìƒë‹¨ ì„¹ì…˜ - ì´ë¯¸ì§€ì™€ ê¸°ë³¸ ì •ë³´ */}
            <div className="flex flex-col sm:flex-row gap-4 sm:gap-6">
              {/* ì‚¬ê°í˜• í° ì´ë¯¸ì§€ - ëª¨ë°”ì¼ì—ì„œëŠ” ì‘ê²Œ */}
              <div className="w-full sm:w-2/5 aspect-square overflow-hidden rounded-lg border-4 border-gray-800 shadow-xl">
                <img 
                  src={dopple.image} 
                  alt={dopple.name} 
                  className="w-full h-full object-cover" 
                />
              </div>
              
              {/* ê¸°ë³¸ ì •ë³´ */}
              <div className="flex-1 space-y-3 sm:space-y-4">
                <div>
                  <h2 className="text-xl sm:text-2xl font-bold text-white mb-1">{dopple.name}</h2>
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="px-2 py-0.5 bg-[#0abab5]/20 text-[#0abab5] rounded-full text-sm">
                      Lv.{dopple.level || 1}
                    </span>
                    <span className="px-2 py-0.5 bg-gray-800 text-gray-300 rounded-full text-xs sm:text-sm flex items-center">
                      <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      ìƒì„±ë¨: {new Date(dopple.createdAt || Date.now()).toLocaleDateString()}
                    </span>
                  </div>
                </div>
                
                {/* ë„í”Œ ê¸°ë³¸ ì„¤ëª… */}
                <div>
                  <p className="text-sm sm:text-base text-gray-300">{dopple.description || 'ì•„ì§ ìê¸° ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
                </div>
                
                {/* ë„í”Œ í†µê³„ */}
                <div className="grid grid-cols-3 gap-2 pt-2">
                  <div className="bg-gray-800/50 p-2 rounded-lg text-center">
                    <div className="text-base sm:text-lg font-semibold text-[#0abab5]">{dopple.chatCount || 0}</div>
                    <div className="text-xs text-gray-400">ëŒ€í™”</div>
                  </div>
                  <div className="bg-gray-800/50 p-2 rounded-lg text-center">
                    <div className="text-base sm:text-lg font-semibold text-[#0abab5]">{dopple.memoryCount || 0}</div>
                    <div className="text-xs text-gray-400">ê¸°ì–µ</div>
                  </div>
                  <div className="bg-gray-800/50 p-2 rounded-lg text-center">
                    <div className="text-base sm:text-lg font-semibold text-[#0abab5]">{dopple.favoriteCount || 0}</div>
                    <div className="text-xs text-gray-400">ì¢‹ì•„ìš”</div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* êµ¬ë¶„ì„  */}
            <div className="h-px bg-gray-800 my-4 sm:my-6"></div>
            
            {/* ë„í”Œ ìƒì„¸ ì •ë³´ - ëª¨ë°”ì¼ì—ì„œëŠ” 1ì—´ë¡œ */}
            <div className="grid grid-cols-1 gap-3 sm:gap-5">
              {/* MBTI ë° ì„±ê²© */}
              <div className="bg-gray-800/30 p-3 sm:p-4 rounded-lg space-y-2 sm:space-y-3">
                <h4 className="text-sm sm:text-md font-medium text-[#0abab5] flex items-center">
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  ì„±ê²© ë° íŠ¹ì„±
                </h4>
                
                {/* MBTI */}
                <div className="flex items-center">
                  <span className="text-xs sm:text-sm font-medium text-gray-400 w-16 sm:w-20">MBTI:</span>
                  <span className="text-sm sm:text-base text-white font-medium">{dopple.mbti || 'NONE'}</span>
                </div>
                
                {/* íŠ¹ì„± íƒœê·¸ */}
                <div>
                  <span className="text-xs sm:text-sm font-medium text-gray-400 block mb-1 sm:mb-2">íŠ¹ì„±:</span>
                  <div className="flex flex-wrap gap-1 sm:gap-2">
                    {(dopple.traits || ['ì¹œì ˆí•¨', 'ì°½ì˜ì ', 'ê³µê°ëŠ¥ë ¥', 'ì§€ì í˜¸ê¸°ì‹¬']).map((trait: string, index: number) => (
                      <span key={index} className="px-2 py-0.5 sm:py-1 bg-gray-700 rounded-full text-xs border border-gray-600">
                        {trait}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* ê´€ì‹¬ì‚¬ */}
              <div className="bg-gray-800/30 p-3 sm:p-4 rounded-lg space-y-2 sm:space-y-3">
                <h4 className="text-sm sm:text-md font-medium text-[#0abab5] flex items-center">
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  ê´€ì‹¬ì‚¬ ë° ì·¨ë¯¸
                </h4>
                
                <div className="flex flex-wrap gap-1 sm:gap-2">
                  {(dopple.interests || ['ìŒì•…', 'ì˜í™”', 'ê²Œì„', 'ë…ì„œ', 'ì—¬í–‰', 'ìš”ë¦¬']).map((interest: string, index: number) => (
                    <span key={index} className="px-2 py-0.5 sm:py-1 bg-gray-700 rounded-full text-xs border border-gray-600 flex items-center">
                      <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-[#0abab5] rounded-full mr-1"></span>
                      {interest}
                    </span>
                  ))}
                </div>
              </div>
              
              {/* ê°ì •í‘œí˜„ */}
              <div className="bg-gray-800/30 p-3 sm:p-4 rounded-lg space-y-2 sm:space-y-3">
                <h4 className="text-sm sm:text-md font-medium text-[#0abab5] flex items-center">
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  ê°ì • í‘œí˜„
                </h4>
                
                <div className="flex items-center">
                  <span className="text-xs sm:text-sm font-medium text-gray-400 w-20 sm:w-24">ê°ì • ë²”ìœ„:</span>
                  <div className="w-full bg-gray-700 rounded-full h-2 sm:h-2.5">
                    <div className={`h-2 sm:h-2.5 rounded-full bg-[#8a2be2]`} style={{ width: `${(dopple.emotionRange || 80)}%` }}></div>
                  </div>
                  <span className="ml-2 text-xs text-gray-300">{dopple.emotionRange || 80}%</span>
                </div>
                
                <div>
                  <span className="text-xs sm:text-sm font-medium text-gray-400 block mb-1 sm:mb-2">ëŒ€í‘œ ê°ì •:</span>
                  <div className="grid grid-cols-4 gap-1 sm:gap-2">
                    {['ê¸°ì¨', 'ìŠ¬í””', 'í™”ë‚¨', 'ë†€ëŒ'].map((emotion, index) => (
                      <div key={index} className="flex flex-col items-center">
                        <div className={`w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center ${index === 0 ? 'bg-yellow-500/20 text-yellow-400' : index === 1 ? 'bg-blue-500/20 text-blue-400' : index === 2 ? 'bg-red-500/20 text-red-400' : 'bg-purple-500/20 text-purple-400'}`}>
                          {index === 0 ? 'ğŸ˜Š' : index === 1 ? 'ğŸ˜¢' : index === 2 ? 'ğŸ˜ ' : 'ğŸ˜²'}
                        </div>
                        <span className="text-xs mt-0.5 sm:mt-1 text-gray-300">{emotion}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* ë ˆë²¨ ì •ë³´ */}
              <div className="bg-gray-800/30 p-3 sm:p-4 rounded-lg space-y-2 sm:space-y-3">
                <h4 className="text-sm sm:text-md font-medium text-[#0abab5] flex items-center">
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  ë ˆë²¨ ë° ëŠ¥ë ¥
                </h4>
                
                <div className="flex items-center">
                  <span className="text-xs sm:text-sm font-medium text-gray-400 w-20 sm:w-24">ë ˆë²¨:</span>
                  <span className="text-sm sm:text-base text-white font-medium">{dopple.level || 1} / 10</span>
                </div>
                
                <div className="flex items-center">
                  <span className="text-xs sm:text-sm font-medium text-gray-400 w-20 sm:w-24">ì„±ì¥ë„:</span>
                  <div className="w-full bg-gray-700 rounded-full h-2 sm:h-2.5">
                    <div className="h-2 sm:h-2.5 rounded-full bg-[#8a2be2]" style={{ width: `${(dopple.level || 1) * 10}%` }}></div>
                  </div>
                  <span className="ml-2 text-xs text-gray-300">{(dopple.level || 1) * 10}%</span>
                </div>
                
                <div className="text-xs text-gray-400 mt-1 sm:mt-2">
                  * ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ë” ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì™€ ë‹¤ì–‘í•œ ê°ì • í‘œí˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>
              </div>
            </div>
            
            {/* ë±ƒì§€ ë° ì—…ì  */}
            <div className="mt-4 sm:mt-6">
              <h4 className="text-sm sm:text-md font-medium text-[#0abab5] mb-2 sm:mb-3 flex items-center">
                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                íšë“í•œ ë±ƒì§€
              </h4>
              
              {/* ë±ƒì§€ ê·¸ë¦¬ë“œ - ëª¨ë°”ì¼ì—ì„œëŠ” ë” ì‘ê²Œ */}
              <div className="grid grid-cols-4 sm:grid-cols-6 gap-2 sm:gap-3">
                {[
                  { name: 'ì²« ëŒ€í™”', icon: 'ğŸ’¬', active: true },
                  { name: 'ì¸ê¸° ë„í”Œ', icon: 'ğŸŒŸ', active: false },
                  { name: 'ê¸°ì–µì˜ ë‹¬ì¸', icon: 'ğŸ§ ', active: true },
                  { name: 'ê°ì • í’ë¶€', icon: 'ğŸ˜Š', active: dopple.level > 3 },
                  { name: 'ëŒ€í™” ë§ˆìŠ¤í„°', icon: 'ğŸ‘‘', active: false },
                  { name: 'ì§€ì‹ ì°½ê³ ', icon: 'ğŸ“š', active: dopple.level > 5 }
                ].map((badge, index) => (
                  <div key={index} className={`flex flex-col items-center ${badge.active ? 'opacity-100' : 'opacity-30'}`}>
                    <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center text-lg sm:text-xl ${badge.active ? 'bg-gray-700 border border-gray-500' : 'bg-gray-800 border border-gray-700'}`}>
                      {badge.icon}
                    </div>
                    <span className="text-xs mt-0.5 sm:mt-1 text-center text-gray-300">{badge.name}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
          
          {/* ëª¨ë‹¬ í‘¸í„° - ëª¨ë°”ì¼ì—ì„œëŠ” ì‘ê³  ê°„ê²°í•˜ê²Œ */}
          <div className="px-3 py-3 sm:px-6 sm:py-4 border-t border-gray-800 flex justify-between shrink-0">
            <div className="flex gap-1 sm:gap-2">
              <button 
                className={`px-2 sm:px-4 py-1.5 sm:py-2 ${isLiked ? 'bg-pink-500/20 text-pink-400 border border-pink-500/30' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'} rounded-lg text-xs sm:text-sm flex items-center transition-colors`}
                onClick={handleLikeToggle}
              >
                <svg className={`w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 ${isLiked ? 'fill-current' : 'fill-none stroke-current'}`} viewBox="0 0 24 24">
                  <path 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    strokeWidth={2} 
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" 
                  />
                </svg>
                {isLiked ? 'ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ì¢‹ì•„ìš”'}
              </button>
              <button 
                className="px-2 sm:px-4 py-1.5 sm:py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs sm:text-sm text-gray-300 flex items-center transition-colors"
                onClick={handleShare}
              >
                <svg className="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                ê³µìœ 
              </button>
            </div>
            
            <button 
              className="px-4 sm:px-6 py-1.5 sm:py-2 bg-[#0abab5] text-white rounded-lg hover:bg-[#0abab5]/80 font-medium text-sm"
              onClick={() => setShowProfileModal(false)}
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë§ˆìš´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ë•Œ
  if (!mounted || isLoading || !isAuthenticated || !dopple || !activeConversation) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#8a2be2]"></div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-gray-900 text-white">
      {/* ì¢‹ì•„ìš” í† ìŠ¤íŠ¸ - ë©”ì¸ í™”ë©´ì—ì„œë„ ë³¼ ìˆ˜ ìˆë„ë¡ */}
      {showLikeToast && !showProfileModal && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
          <svg className="w-4 h-4 mr-2 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clipRule="evenodd" />
          </svg>
          {toastMessage}
        </div>
      )}
      
      {/* ê³µìœ  í† ìŠ¤íŠ¸ - ë©”ì¸ í™”ë©´ì—ì„œë„ ë³¼ ìˆ˜ ìˆë„ë¡ */}
      {showShareToast && !showProfileModal && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
          <svg className="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          {toastMessage}
        </div>
      )}
      
      {/* í† í° ì§€ê¸‰ ì•Œë¦¼ */}
      {showDailyTokenAlert && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600/90 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
          <svg className="w-5 h-5 mr-2 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
          </svg>
          {tokenAlertMessage}
        </div>
      )}
      
      {/* í† í° ì†Œì§„ ì—…ì  ì•Œë¦¼ */}
      {showAchievementAlert && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-purple-600/90 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center animate-fade-in-out">
          <svg className="w-5 h-5 mr-2 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a2 2 0 012-2h6a2 2 0 012 2v1h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1H3a2 2 0 01-2-2V6a2 2 0 012-2h2V3z"/>
          </svg>
          {tokenAlertMessage}
        </div>
      )}
      
      {/* Header - ì „ì²´í™”ë©´ ë° ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */}
      <header className="fixed top-0 left-0 right-0 bg-black/60 backdrop-blur-md border-b border-[#0abab5]/20 z-30">
        <div className="container mx-auto px-2 py-3">
          <div className="flex items-center justify-between">
            {/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */}
            <button
              onClick={() => router.push('/dashboard')}
              className="flex items-center text-gray-300 hover:text-white"
            >
              <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
              <span className="text-sm">ë’¤ë¡œ</span>
            </button>
            
            {/* Dopple Info - í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ */}
            <div 
              className="flex items-center cursor-pointer"
              onClick={() => setShowProfileModal(true)}
            >
              <div className="h-8 w-8 rounded-full overflow-hidden mr-2">
                <img src={dopple.image} alt={dopple.name} className="h-full w-full object-cover" />
              </div>
              <span className="text-sm font-medium">{dopple.name}</span>
              <span className="ml-2 text-xs px-2 py-0.5 bg-[#0abab5]/20 text-[#0abab5] rounded-full">
                Lv.{dopple.level || 1}
              </span>
              <svg className="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            
            {/* ìë™ëŒ€í™” ì»¨íŠ¸ë¡¤ */}
            {dopple.level >= 3 && partnerDopple && (
              <div className="flex items-center space-x-2">
                {!isAutoConversationActive ? (
                  <button
                    className={`px-2 py-1 rounded-full flex items-center ${dopple.isMinted ? 'bg-[#0abab5]/20 text-[#0abab5] hover:bg-[#0abab5]/30' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}`}
                    onClick={startAutoConversation}
                    disabled={!dopple.isMinted}
                  >
                    <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                    </svg>
                    <span className="text-xs">í”Œë ˆì´</span>
                  </button>
                ) : (
                  <button
                    className="px-2 py-1 bg-red-500/20 text-red-400 rounded-full flex items-center hover:bg-red-500/30"
                    onClick={stopAutoConversation}
                  >
                    <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clipRule="evenodd" />
                    </svg>
                    <span className="text-xs">ì¤‘ë‹¨</span>
                  </button>
                )}
                
                {!dopple.isMinted && (
                  <button
                    className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-full flex items-center hover:bg-purple-500/30"
                    onClick={() => setShowMintModal(true)}
                  >
                    <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fillRule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zm7-10a1 1 0 01.707.293l.707.707L15.414 5a1 1 0 01-1.414 1.414L13 5.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707L10.586 3A1 1 0 0112 2zm0 10a1 1 0 01.707.293l.707.707L15.414 15a1 1 0 01-1.414 1.414L13 15.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707L10.586 13A1 1 0 0112 12z" clipRule="evenodd" />
                    </svg>
                    <span className="text-xs">ë¯¼íŒ…</span>
                  </button>
                )}
              </div>
            )}
            
            {/* í† í° í‘œì‹œ */}
            <div className="flex items-center space-x-2">
              <span className="text-xs px-2 py-0.5 bg-gray-800 rounded-full flex items-center">
                <svg className="w-3 h-3 mr-1 text-[#0abab5]" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z" />
                </svg>
                {tokenBalance} WHM
              </span>
              <span className="text-xs px-2 py-0.5 bg-gray-800 rounded-full">
                {messageCount}/{dailyLimit}
              </span>
            </div>
          </div>
        </div>
      </header>

      {/* Chat Area - ì „ì²´í™”ë©´ ëª¨ë“œ */}
      <main className={`flex-grow ${(isLimited || isTokenLimited) ? 'pt-24 sm:pt-28' : 'pt-16 sm:pt-20'} pb-20 px-2 sm:px-4 overflow-y-auto`}>
        <div className="max-w-3xl mx-auto">
          <div className="space-y-3 py-2">
            {/* ê¸°ì¡´ ë©”ì‹œì§€ */}
            {activeConversation.messages
              .filter(msg => msg.role !== 'system')
              .map(message => (
                <ChatMessage 
                  key={message.id} 
                  message={message} 
                  doppleName={dopple.name}
                  doppleImage={dopple.image} 
                />
              ))
            }
            
            {/* ë©”ì‹œì§€ ìƒì„± ì¤‘ í‘œì‹œ */}
            {isGenerating && (
              <div className="flex justify-start mb-3">
                <div className="flex-shrink-0 h-8 w-8 sm:h-10 sm:w-10 rounded-full overflow-hidden mr-2 sm:mr-3">
                  <img src={dopple.image} alt={dopple.name} className="h-full w-full object-cover" />
                </div>
                <div className="bg-gray-800 text-white rounded-2xl rounded-tl-none px-3 py-2 sm:px-4 sm:py-3">
                  <div className="flex space-x-1">
                    <div className="w-2 h-2 bg-gray-600 rounded-full animate-pulse"></div>
                    <div className="w-2 h-2 bg-gray-600 rounded-full animate-pulse delay-100"></div>
                    <div className="w-2 h-2 bg-gray-600 rounded-full animate-pulse delay-200"></div>
                  </div>
                </div>
              </div>
            )}
            
            {/* ìŠ¤í¬ë¡¤ ìœ„ì¹˜ìš© ì°¸ì¡° */}
            <div ref={messagesEndRef} />
          </div>
        </div>
      </main>

      {/* í† í° ë¶€ì¡± ê²½ê³  */}
      {isTokenLimited && (
        <div className="fixed top-16 sm:top-20 left-0 right-0 bg-yellow-600/80 text-white p-2 text-center">
          <div className="flex flex-wrap items-center justify-center gap-2">
            <span className="text-sm">í† í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</span>
            <Link href="/token-shop" className="px-2 py-1 bg-white text-yellow-600 rounded-md text-xs font-medium">
              í† í° ì¶©ì „í•˜ê¸°
            </Link>
          </div>
        </div>
      )}
      
      {/* ì¼ì¼ ë©”ì‹œì§€ ì œí•œ ê²½ê³  */}
      {isLimited && !isTokenLimited && (
        <div className="fixed top-16 sm:top-20 left-0 right-0 bg-red-600/80 text-white p-2 text-center">
          <span className="text-sm">ì˜¤ëŠ˜ì˜ ë¬´ë£Œ ë©”ì‹œì§€ í•œë„({dailyLimit}ê°œ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.</span>
        </div>
      )}

      {/* Input Area */}
      <footer className="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-2 sm:p-4">
        <div className="max-w-3xl mx-auto">
          {/* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */}
          {imagePreviews.length > 0 && (
            <div className="flex space-x-2 mb-2">
              {imagePreviews.map((url, index) => (
                <div key={index} className="relative h-14 w-14 sm:h-16 sm:w-16">
                  <img src={url} alt="Preview" className="h-full w-full object-cover rounded" />
                  <button 
                    onClick={() => handleRemoveImage(index)}
                    className="absolute -top-2 -right-2 bg-white rounded-full shadow"
                  >
                    <IoCloseCircle className="text-red-500 text-lg" />
                  </button>
                </div>
              ))}
            </div>
          )}
          
          <div className="flex items-end">
            {/* í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­ */}
            <textarea
              ref={inputRef}
              className="flex-grow bg-gray-700 text-white rounded-lg border border-gray-600 resize-none p-2 sm:p-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-[#0abab5] focus:border-transparent"
              placeholder={isTokenLimited ? "í† í°ì„ ì¶©ì „í•´ì£¼ì„¸ìš”..." : "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."}
              rows={1}
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              onKeyDown={handleKeyDown}
              disabled={isGenerating || isTokenLimited}
            ></textarea>
            
            {/* ì „ì†¡ ë²„íŠ¼ */}
            {isTokenLimited ? (
              <Link href="/token-shop" className="ml-2 bg-yellow-500 text-white rounded-lg p-2 sm:p-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </Link>
            ) : (
              <button
                className="ml-2 bg-[#0abab5] text-white rounded-lg p-2 sm:p-3 hover:bg-[#0abab5]/80 focus:outline-none focus:ring-2 focus:ring-[#0abab5] disabled:opacity-50 disabled:cursor-not-allowed"
                onClick={handleSendMessage}
                disabled={(!message.trim() && selectedImages.length === 0) || isGenerating || isLimited}
              >
                <IoSendSharp className="text-lg sm:text-xl" />
              </button>
            )}
          </div>
          
          {/* ì´ëª¨í‹°ì½˜ ì„ íƒê¸° */}
          {showEmojiPicker && (
            <div 
              ref={emojiPickerRef}
              className="absolute bottom-16 sm:bottom-20 right-2 sm:right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-1 sm:p-2 z-50 max-w-[90vw] sm:max-w-[320px]"
            >
              <div className="emoji-picker-wrapper" style={{ maxHeight: '40vh', overflow: 'auto' }}>
                <EmojiPicker onEmojiClick={handleEmojiClick} width="100%" height="100%" />
              </div>
            </div>
          )}
          
          <div className="mt-2 flex items-center justify-between">
            <div className="flex items-center">
              {/* ì´ëª¨í‹°ì½˜ ë²„íŠ¼ */}
              <button
                className="mr-3 text-gray-400 hover:text-gray-300 focus:outline-none"
                onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                disabled={isGenerating || isTokenLimited}
              >
                <IoHappyOutline className="text-xl" />
              </button>
              
              {/* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ */}
              <label className="text-gray-400 hover:text-gray-300 cursor-pointer">
                <IoImageOutline className="text-xl" />
                <input 
                  type="file" 
                  ref={fileInputRef}
                  className="hidden"
                  accept="image/*"
                  multiple
                  onChange={handleImageSelect}
                />
              </label>
            </div>
            
            <div>
              <button 
                className="text-[#0abab5] hover:underline text-xs"
                onClick={() => {
                  if (activeConversation && window.confirm('í˜„ì¬ ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ê³  ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    memory.endConversation(activeConversation.id);
                    const newConversation = memory.startConversation();
                    setActiveConversation(newConversation);
                    
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
                    memory.addMessage(newConversation.id, {
                      role: 'system',
                      content: `ë‹¹ì‹ ì€ ${dopple.name}ì´ë¼ëŠ” AI ë„í”Œê°±ì–´ì…ë‹ˆë‹¤. ì‚¬ìš©ìì™€ ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”.`
                    });
                    
                    // ì´ˆê¸° ì¸ì‚¬ ë©”ì‹œì§€
                    memory.addMessage(newConversation.id, {
                      role: 'dopple',
                      content: `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ${dopple.name}ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`
                    });
                  }
                }}
              >
                ìƒˆ ëŒ€í™” ì‹œì‘
              </button>
            </div>
          </div>
        </div>
      </footer>
      
      {/* ë„í”Œ í”„ë¡œí•„ ëª¨ë‹¬ */}
      {showProfileModal && <DoppleProfileModal />}
      
      {/* ë¯¼íŒ… ëª¨ë‹¬ */}
      {showMintModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div className="bg-gray-900 rounded-xl w-full max-w-md p-6 border border-gray-800">
            <h3 className="text-xl font-bold mb-4">ë„í”Œ ë¯¼íŒ…</h3>
            <p className="text-gray-300 mb-6">
              ì´ ë„í”Œì„ ë¯¼íŒ…í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë¯¼íŒ…ëœ ë„í”Œì€ ë‹¤ë¥¸ ë„í”Œë“¤ê³¼ ìë™ëŒ€í™”ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              {dopple.level < 3 && " ë¯¼íŒ…í•˜ë ¤ë©´ ë„í”Œ ë ˆë²¨ì´ 3 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."}
            </p>
            <div className="flex justify-end space-x-4">
              <button 
                className="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700"
                onClick={() => setShowMintModal(false)}
              >
                ì·¨ì†Œ
              </button>
              <button 
                className={`px-4 py-2 bg-[#0abab5] text-white rounded-lg ${dopple.level >= 3 ? 'hover:bg-[#0abab5]/80' : 'opacity-50 cursor-not-allowed'}`}
                onClick={handleMinting}
                disabled={dopple.level < 3}
              >
                ë¯¼íŒ…í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* ìë™ëŒ€í™” ì»¨íŠ¸ë¡¤ */}
      {dopple.level >= 3 && partnerDopple && (
        <div className="flex items-center space-x-2">
          {!isAutoConversationActive ? (
            <button
              className={`px-2 py-1 rounded-full flex items-center ${dopple.isMinted ? 'bg-[#0abab5]/20 text-[#0abab5] hover:bg-[#0abab5]/30' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}`}
              onClick={startAutoConversation}
              disabled={!dopple.isMinted}
            >
              <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
              </svg>
              <span className="text-xs">í”Œë ˆì´</span>
            </button>
          ) : (
            <button
              className="px-2 py-1 bg-red-500/20 text-red-400 rounded-full flex items-center hover:bg-red-500/30"
              onClick={stopAutoConversation}
            >
              <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clipRule="evenodd" />
              </svg>
              <span className="text-xs">ì¤‘ë‹¨</span>
            </button>
          )}
          
          {!dopple.isMinted && (
            <button
              className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-full flex items-center hover:bg-purple-500/30"
              onClick={() => setShowMintModal(true)}
            >
              <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zm7-10a1 1 0 01.707.293l.707.707L15.414 5a1 1 0 01-1.414 1.414L13 5.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707L10.586 3A1 1 0 0112 2zm0 10a1 1 0 01.707.293l.707.707L15.414 15a1 1 0 01-1.414 1.414L13 15.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707L10.586 13A1 1 0 0112 12z" clipRule="evenodd" />
              </svg>
              <span className="text-xs">ë¯¼íŒ…</span>
            </button>
          )}
        </div>
      )}
    </div>
  );
} 

// ìë™ëŒ€í™” ì‹œì‘ í•¨ìˆ˜
const startAutoConversation = useCallback(() => {
  if (!dopple || !activeConversation) {
    console.error('ë„í”Œ ë˜ëŠ” ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ë„í”Œì´ ë¯¼íŒ…ë˜ì§€ ì•Šì€ ê²½ìš° ë¯¼íŒ… ëª¨ë‹¬ í‘œì‹œ
  if (!dopple.isMinted) {
    setShowMintModal(true);
    return;
  }

  // ì´ë¯¸ ìë™ëŒ€í™”ê°€ ì§„í–‰ ì¤‘ì¸ ê²½ìš°
  if (isAutoConversationActive) {
    console.log('ì´ë¯¸ ìë™ëŒ€í™”ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
    return;
  }

  // íŒŒíŠ¸ë„ˆ ë„í”Œ ì´ˆê¸°í™” (ë¯¸êµ¬í˜„ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©)
  let partner = partnerDopple;
  if (!partner) {
    // ê¸°ë³¸ íŒŒíŠ¸ë„ˆ ë„í”Œ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ì— ë§ê²Œ ì¡°ì • í•„ìš”)
    partner = {
      id: 'default-partner',
      name: 'ë„í”Œ ì¹œêµ¬',
      traits: ['ì¹œì ˆí•¨', 'í˜¸ê¸°ì‹¬'],
      interests: ['ëŒ€í™”', 'ìŒì•…'],
      isMinted: true
    };
    setPartnerDopple(partner);
  }

  // ìë™ëŒ€í™” ì‹œì‘ ë©”ì‹œì§€ ê¸°ë¡
  memory.addMessage(activeConversation, {
    role: 'system',
    content: 'ìë™ëŒ€í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
    timestamp: new Date().toISOString()
  });

  // ìë™ ëŒ€í™” ì‹œì‘
  setIsAutoConversationActive(true);
  const interval = generateAutomaticConversation(
    dopple,
    partner,
    activeConversation,
    memory,
    setIsAutoConversationActive
  );
  
  setAutoConversationInterval(interval);
}, [dopple, partnerDopple, activeConversation, isAutoConversationActive, memory, setPartnerDopple, setIsAutoConversationActive, setAutoConversationInterval]);

// ìë™ëŒ€í™” ì¤‘ì§€ í•¨ìˆ˜
const stopAutoConversation = useCallback(() => {
  if (autoConversationInterval) {
    clearInterval(autoConversationInterval);
    setAutoConversationInterval(null);
  }
  
  setIsAutoConversationActive(false);
  
  if (activeConversation) {
    memory.addMessage(activeConversation, {
      role: 'system',
      content: 'ìë™ëŒ€í™”ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
      timestamp: new Date().toISOString()
    });
  }
}, [autoConversationInterval, activeConversation, memory, setIsAutoConversationActive, setAutoConversationInterval]);

// ë¯¼íŒ… ì²˜ë¦¬ í•¨ìˆ˜
const handleMinting = useCallback(() => {
  if (!dopple) return;
  
  const MINTING_COST = 100; // ë¯¼íŒ…ì— í•„ìš”í•œ í† í° ìˆ˜ (ì‹¤ì œ êµ¬í˜„ì— ë§ê²Œ ì¡°ì •)
  
  // í† í° ì”ì•¡ í™•ì¸
  if (tokenBalance < MINTING_COST) {
    alert(`ë¯¼íŒ…ì—ëŠ” ${MINTING_COST} í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ ì”ì•¡: ${tokenBalance}`);
    setShowMintModal(false);
    return;
  }
  
  // ë„í”Œ ë¯¼íŒ… ì²˜ë¦¬
  const updatedDopple = {
    ...dopple,
    isMinted: true,
    mintedAt: new Date().toISOString()
  };
  
  // ìƒíƒœ ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
  setDopple(updatedDopple);
  const updatedBalance = tokenBalance - MINTING_COST;
  setTokenBalance(updatedBalance);
  
  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
  const dopples = JSON.parse(localStorage.getItem('myDopples') || '[]');
  const updatedDopples = dopples.map((d: any) => d.id === dopple.id ? updatedDopple : d);
  localStorage.setItem('myDopples', JSON.stringify(updatedDopples));
  localStorage.setItem('tokenBalance', updatedBalance.toString());
  
  // ë¯¼íŒ… ëª¨ë‹¬ ë‹«ê¸°
  setShowMintModal(false);
  
  // ë¯¼íŒ… ì„±ê³µ ë©”ì‹œì§€
  if (activeConversation) {
    memory.addMessage(activeConversation, {
      role: 'system',
      content: `${dopple.name}ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ë¯¼íŒ…ë˜ì—ˆìŠµë‹ˆë‹¤!`,
      timestamp: new Date().toISOString()
    });
  }
}, [dopple, tokenBalance, activeConversation, memory, setDopple, setTokenBalance, setShowMintModal]);